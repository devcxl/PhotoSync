name: Android Release

on:
    push:
        tags:
            - 'v*'

permissions:
    contents: write

jobs:
    build:
        name: Build Release APK
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout
                uses: actions/checkout@v4
                with:
                    fetch-depth: 0

            -   name: Set up JDK 17
                uses: actions/setup-java@v4
                with:
                    distribution: 'temurin'
                    java-version: '17'

            -   name: Set up Gradle
                uses: gradle/actions/setup-gradle@v4

            -   name: Set up Android SDK
                uses: android-actions/setup-android@v3

            -   name: Install Android SDK components (API 36, NDK, CMake) and accept licenses
                shell: bash
                run: |
                    yes | sdkmanager --licenses || true
                    sdkmanager --install \
                        "platform-tools" \
                        "platforms;android-36" \
                        "build-tools;36.0.0" \
                        "ndk;29.0.14033849" \
                        "cmake;3.22.1"

            -   name: Point local.properties to CI Android SDK
                run: |
                    echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties

            -   name: Align Gradle JDK with runner JAVA_HOME
                run: |
                    sed -i '/^org\.gradle\.java\.home=/d' gradle.properties
                    echo "org.gradle.java.home=${JAVA_HOME}" >> gradle.properties

            -   name: Make gradlew executable
                run: chmod +x gradlew

            -   name: Decode keystore file
                run: | 
                    echo "${KEYSTORE_BASE64}" | base64 --decode > "${GITHUB_WORKSPACE}/release.keystore"
                    echo "Keystore written to ${GITHUB_WORKSPACE}/release.keystore"
                env:
                    KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}

            -   name: Build release APK (signed)
                run: ./gradlew --no-daemon clean :app:assembleRelease
                env:
                    KEYSTORE_PATH: "${{ github.workspace }}/release.keystore"
                    KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
                    KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
                    KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

            -   name: Upload signed APK artifact
                uses: actions/upload-artifact@v4
                with:
                    name: app-release-apk
                    path: app/build/outputs/apk/release/app-release.apk
                    if-no-files-found: error

            -   name: Clean up keystore
                if: always()
                run: |
                    rm -f release.keystore
                    echo "Keystore file removed."

    release:
        name: Create Draft Release
        needs: build
        if: startsWith(github.ref, 'refs/tags/')
        runs-on: ubuntu-latest
        steps:
            -   name: Download APK artifact
                uses: actions/download-artifact@v4
                with:
                    name: app-release-apk
                    path: artifacts

            -   name: Create GitHub Release (draft) and upload APKs
                uses: softprops/action-gh-release@v2
                with:
                    files: artifacts/*.apk
                    draft: true
                    tag_name: ${{ github.ref_name }}
                    generate_release_notes: true
                env:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
